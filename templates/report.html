<!DOCTYPE html>
<html>
<head>
    <title>Weekly Report</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/pulse/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="/">
            <img src="/static/logo.png" height="40" class="me-2" alt="Logo">
            Sharp Time Tracker
        </a>
        <div class="ms-auto">
            <a href="/download" class="btn btn-outline-light me-2">Download CSV</a>
            <a href="/report" class="btn btn-outline-light me-2">Weekly Report</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h2>Weekly Time Report</h2>
    <div class="chart-container">
        <canvas id="weekly-chart" height="200"></canvas>
    </div>
    <div class="row mt-3">
        <div class="col-md-3">
            <label class="form-label">Person</label>
            <select id="person-filter" class="form-select"><option value="">-- Select --</option></select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Day</label>
            <select id="day-filter" class="form-select"><option value="">-- Select --</option></select>
        </div>
    </div>
    <div id="summary" class="mt-3"></div>
    <a href="/weekly-download" class="btn btn-success mt-3">Download Weekly CSV</a>
    <a href="/" class="btn btn-secondary mt-3">Back to Log</a>
</div>
<script>
let weekdaysData, dailyData, chart;
fetch('/weekdays-data').then(res => res.json()).then(data => {
    const canvas = document.getElementById('weekly-chart');
    const ctx = canvas.getContext('2d');
    const labels = data.days;

    const makeDatasets = names => names.map((n, i) => ({
        label: n,
        data: data.hours[n],
        backgroundColor: `hsl(${(i * 40) % 360},70%,60%)`
    }));

    const updateWidth = count => {
        canvas.width = labels.length * count * 40;
    };

    chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: makeDatasets(data.names) },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { title: { display: true, text: 'Hours Per Day' } },
            scales: { x: { stacked: false }, y: { stacked: false, beginAtZero: true } }
        }
    });
    updateWidth(data.names.length);

    weekdaysData = data;
    const personSelect = document.getElementById('person-filter');
    data.names.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n; opt.textContent = n; personSelect.appendChild(opt);
    });

    personSelect.addEventListener('change', () => {
        const name = personSelect.value;
        const names = name ? [name] : data.names;
        chart.data.datasets = makeDatasets(names);
        updateWidth(names.length);
        chart.update();
    });
});

fetch('/daily-data').then(r=>r.json()).then(d => {
    dailyData = d;
    const daySel = document.getElementById('day-filter');
    d.dates.forEach(date => {
        const opt = document.createElement('option');
        opt.value = date; opt.textContent = date; daySel.appendChild(opt);
    });
});

const summary = document.getElementById('summary');

document.getElementById('day-filter').addEventListener('change', e => {
    if(!dailyData) return;
    const day = e.target.value;
    if(!day) { summary.textContent=''; return; }
    const idx = dailyData.dates.indexOf(day);
    let html = '<h5>Hours on '+day+'</h5><ul>';
    dailyData.names.forEach(n => {
        const h = dailyData.hours[n][idx] || 0;
        html += `<li>${n}: ${h.toFixed(2)}h ${h>=8?'✓':'✗'}</li>`;
    });
    html += '</ul>';
    summary.innerHTML = html;
});
</script>
</body>
</html>
