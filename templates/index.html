<!DOCTYPE html>
<html>
<head>
    <title>Time Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/pulse/bootstrap.min.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <img src="/static/logo.png" height="40" class="me-2" alt="Logo">
            Sharp Time Tracker
        </a>
        <div class="ms-auto">
            <a href="/download" class="btn btn-outline-light me-2">Download CSV</a>
            <a href="/report" class="btn btn-outline-light me-2">Weekly Report</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="card p-3 mb-4">
    <form id="entry-form" class="row g-2 align-items-end" enctype="multipart/form-data">
        <div class="col-md-2">
            <label class="form-label">Name</label>
            <input name="name" class="form-control" required>
        </div>
        <div class="col-md-2">
            <label class="form-label">Date</label>
            <input name="date" type="date" class="form-control" required>
        </div>
        <div class="col-md-2">
            <label class="form-label">From</label>
            <input name="from_time" type="time" class="form-control" required>
        </div>
        <div class="col-md-2">
            <label class="form-label">To</label>
            <input name="to_time" type="time" class="form-control" required>
        </div>
        <div class="col-md-2">
            <label class="form-label">Task</label>
            <input name="task" class="form-control" required>
        </div>
        <div class="col-md-2">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="1"></textarea>
            <input type="file" name="file" class="form-control mt-1">
            <div class="form-check mt-1">
                <input class="form-check-input" type="checkbox" name="completed" id="completed" checked>
                <label class="form-check-label" for="completed">Completed</label>
            </div>
        </div>
        <div class="col-md-1 d-grid">
            <button type="submit" class="btn btn-primary mt-3">Add</button>
        </div>
    </form>
    </div>
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Date</th>
                <th>Duration</th>
                <th>Task</th>
                <th>Description</th>
                <th>File</th>
                <th>Completed</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="entry-body">
        {% for row in data %}
            <tr>
                <td>{{ row['Name'] }}</td>
                <td>{{ row.date_display }}</td>
                <td>{{ row.duration_str }}</td>
                <td>{{ row['Task'] }}</td>
                <td>{{ row['Description']|linkify|safe }}</td>
                <td>{% if row['File'] %}<a href="/uploads/{{ row['File'] }}" target="_blank" download>{{ row['File'] }}</a>{% endif %}</td>
                <td>{{ 'Yes' if row['Completed'] == '1' else 'No' }}</td>
                <td><a href="/edit/{{ row.index }}" class="btn btn-sm btn-secondary">Edit</a></td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('entry-form');
    const nameField = form.querySelector('input[name="name"]');
    let storedName = localStorage.getItem('name');
    if (!storedName) {
        storedName = prompt('Please enter your name:');
        if (storedName) localStorage.setItem('name', storedName);
    }
    if (storedName) nameField.value = storedName;
    nameField.addEventListener('change', () => localStorage.setItem('name', nameField.value));

    const setCurrentTime = () => {
        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        form.querySelector('input[name="date"]').value = now.toISOString().slice(0,10);
        const timeString = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
        form.querySelector('input[name="from_time"]').value = timeString;
        const later = new Date(now.getTime() + 15*60000);
        const laterStr = `${pad(later.getHours())}:${pad(later.getMinutes())}`;
        form.querySelector('input[name="to_time"]').value = laterStr;
    };
    const adjustEndTime = () => {
        const val = form.querySelector('input[name="from_time"]').value;
        if (!val) return;
        const [h, m] = val.split(':').map(Number);
        const dt = new Date();
        dt.setHours(h, m + 15);
        const pad = n => n.toString().padStart(2, '0');
        form.querySelector('input[name="to_time"]').value = `${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    };
    setCurrentTime();
    form.querySelector('input[name="from_time"]').addEventListener('change', adjustEndTime);

    form.addEventListener('submit', function(e){
        e.preventDefault();
        const data = new FormData(form);
        fetch('/add', {method: 'POST', body: data, headers: {'X-Requested-With': 'XMLHttpRequest'}})
            .then(r => r.json())
            .then(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.name}</td>`+
                    `<td>${row.date_display}</td>`+
                    `<td>${row.duration_str}</td>`+
                    `<td>${row.task}</td>`+
                    `<td>${row.description_html}</td>`+
                    `<td>${row.file_link}</td>`+
                    `<td>${row.completed === '1' ? 'Yes' : 'No'}</td>`+
                    `<td><a href="/edit/${row.index}" class="btn btn-sm btn-secondary">Edit</a></td>`;
                document.getElementById('entry-body').appendChild(tr);
                form.reset();
                if (storedName) nameField.value = storedName;
                setCurrentTime();
            });
    });
});
</script>
</body>
</html>
