<!DOCTYPE html>
<html>
<head>
    <title>Time Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/pulse/bootstrap.min.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <img src="/static/logo.png" height="40" class="me-2" alt="Logo">
            Sharp Time Tracker
        </a>
        <div class="ms-auto">
            <a href="/download" class="btn btn-outline-light me-2">Download CSV</a>
            <a href="/report" class="btn btn-outline-light me-2">Weekly Report</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <form id="entry-form" class="row g-2 mb-3" enctype="multipart/form-data">
        <div class="col-md-2"><input name="name" class="form-control" placeholder="Name" required></div>
        <div class="col-md-2"><input name="date" type="date" class="form-control" required></div>
        <div class="col-md-1"><input name="from_time" type="time" class="form-control" required></div>
        <div class="col-md-1"><input name="to_time" type="time" class="form-control" required></div>
        <div class="col-md-2"><input name="task" class="form-control" placeholder="Task" required></div>
        <div class="col-md-3">
            <textarea name="description" class="form-control" placeholder="Description" rows="1"></textarea>
            <input type="file" name="file" class="form-control mt-1">
        </div>
        <div class="col-md-1 d-grid"><button type="submit" class="btn btn-primary">Add</button></div>
    </form>

    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Date</th>
                <th>Start</th>
                <th>End</th>
                <th>Hours</th>
                <th>Task</th>
                <th>Description</th>
                <th>File</th>
            </tr>
        </thead>
        <tbody id="entry-body">
        {% for row in data %}
            <tr>
                <td>{{ row['Name'] }}</td>
                <td>{{ row.date_display }}</td>
                <td>{{ row['From Time'] }}</td>
                <td>{{ row['To Time'] }}</td>
                <td>{{ row.hours | round(2) }}</td>
                <td>{{ row['Task'] }}</td>
                <td>{{ row['Description']|linkify|safe }}</td>
                <td>{% if row['File'] %}<a href="/uploads/{{ row['File'] }}" target="_blank" download>{{ row['File'] }}</a>{% endif %}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('entry-form');
    const nameField = form.querySelector('input[name="name"]');
    let storedName = localStorage.getItem('name');
    if (!storedName) {
        storedName = prompt('Please enter your name:');
        if (storedName) localStorage.setItem('name', storedName);
    }
    if (storedName) nameField.value = storedName;
    nameField.addEventListener('change', () => localStorage.setItem('name', nameField.value));

    const setCurrentTime = () => {
        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        const timeString = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
        const dateString = now.toLocaleDateString('en-CA');
        form.querySelector('input[name="from_time"]').value = timeString;
        form.querySelector('input[name="to_time"]').value = timeString;
        form.querySelector('input[name="date"]').value = dateString;
    };
    setCurrentTime();

    form.addEventListener('submit', function(e){
        e.preventDefault();
        const data = new FormData(form);
        fetch('/add', {method: 'POST', body: data, headers: {'X-Requested-With': 'XMLHttpRequest'}})
            .then(r => r.json())
            .then(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.name}</td>`+
                    `<td>${row.date_display}</td>`+
                    `<td>${row.from_time}</td>`+
                    `<td>${row.to_time}</td>`+
                    `<td>${row.hours.toFixed(2)}</td>`+
                    `<td>${row.task}</td>`+
                    `<td>${row.description_html}</td>`+
                    `<td>${row.file_link}</td>`;
                document.getElementById('entry-body').appendChild(tr);
                form.reset();
                if (storedName) nameField.value = storedName;
                setCurrentTime();
            });
    });
});
</script>
</body>
</html>
