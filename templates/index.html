<!DOCTYPE html>
<html>
<head>
    <title>Time Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/pulse/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <img src="/static/logo.png" height="40" class="me-2" alt="Logo">
            Sharp Time Tracker
        </a>
        <div class="ms-auto">
            <a href="/download" class="btn btn-outline-light me-2">Download CSV</a>
            <a href="/report" class="btn btn-outline-light me-2">Weekly Report</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="card p-4 mb-4">
    <form id="entry-form" class="row g-3" enctype="multipart/form-data">
        <div class="col-md-2">
            <label class="form-label">Name</label>
            <input name="name" class="form-control" required>
        </div>
        <div class="col-md-2">
            <label class="form-label">Date</label>
            <input name="date" type="date" class="form-control" required>
        </div>
        <div class="col-md-2">
            <label class="form-label">From</label>
            <input name="from_time" type="time" class="form-control" required>
        </div>
        <div class="col-md-2">
            <label class="form-label">To</label>
            <input name="to_time" type="time" class="form-control" required>
        </div>
        <div class="col-md-2">
            <label class="form-label">Task</label>
            <input name="task" class="form-control" required>
        </div>
        <div class="col-md-3">
            <label class="form-label">Description</label>
            <div class="input-group">
                <textarea name="description" class="form-control" rows="1"></textarea>
                <button type="button" class="btn btn-outline-secondary attach-btn"><i class="bi bi-paperclip"></i></button>
            </div>
            <input type="file" name="file" id="file-input" class="d-none">
            <div class="form-check mt-1">
                <input class="form-check-input" type="checkbox" name="completed" id="completed" checked>
                <label class="form-check-label" for="completed">Completed</label>
            </div>
        </div>
        <div class="col-md-1 d-grid">
            <button type="submit" class="btn btn-primary mt-3">Add</button>
        </div>
    </form>
    </div>
    {% if grouped %}
    <div class="accordion" id="day-accordion">
    {% for date, rows in grouped.items() %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ loop.index }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                    {{ format_date(date, show_year) }}
                </button>
            </h2>
            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#day-accordion">
                <div class="accordion-body">
                    <canvas class="day-chart" id="chart-{{ loop.index }}" data-hours='{{ totals[date]|tojson }}'></canvas>
                    <table class="table table-bordered table-striped mt-3">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>From-To</th>
                                <th>Hours</th>
                                <th>Task</th>
                                <th>Description</th>
                                <th>File</th>
                                <th>Completed</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for row in rows %}
                            <tr>
                                <td>{{ row['Name'] }}</td>
                                <td>{{ row['From Time'] }}-{{ row['To Time'] }}</td>
                                <td>{{ '%.2f'|format(row.hours) }}</td>
                                <td>{{ row['Task'] }}</td>
                                <td>{{ row['Description']|linkify|safe }}</td>
                                <td>{% if row['File'] %}<a href="/uploads/{{ row['File'] }}" target="_blank" download>{{ row['File'] }}</a>{% endif %}</td>
                                <td>{{ 'Yes' if row['Completed']=='1' else 'No' }}</td>
                                <td><button class="btn btn-sm btn-secondary edit-btn" data-index="{{ row.index }}">Edit</button></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endfor %}
    </div>
    {% else %}
    <p class="text-center text-muted">No entries found. Add a new entry above.</p>
    {% endif %}

    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="edit-form">
            <div class="modal-header">
              <h5 class="modal-title">Edit Entry</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body row g-3">
              <div class="col-md-4">
                <label class="form-label">Date</label>
                <input type="date" name="date" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">From</label>
                <input type="time" name="from_time" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">To</label>
                <input type="time" name="to_time" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Task</label>
                <input name="task" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control" rows="2"></textarea>
                <div class="form-check mt-1">
                  <input class="form-check-input" type="checkbox" name="completed" id="edit-completed">
                  <label class="form-check-label" for="edit-completed">Completed</label>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const form = document.getElementById('entry-form');
    const fileInput = document.getElementById('file-input');
    document.querySelector('.attach-btn').addEventListener('click', ()=>fileInput.click());
    const nameField = form.querySelector('input[name="name"]');
    let storedName = localStorage.getItem('name');
    if(!storedName){
        storedName = prompt('Please enter your name:');
        if(storedName) localStorage.setItem('name', storedName);
    }
    if(storedName) nameField.value = storedName;
    nameField.addEventListener('change', ()=>localStorage.setItem('name', nameField.value));

    const setCurrentTime = () => {
        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        form.querySelector('input[name="date"]').value = now.toISOString().slice(0,10);
        const timeString = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
        form.querySelector('input[name="from_time"]').value = timeString;
        const later = new Date(now.getTime() + 15*60000);
        const laterStr = `${pad(later.getHours())}:${pad(later.getMinutes())}`;
        form.querySelector('input[name="to_time"]').value = laterStr;
    };
    const adjustEndTime = () => {
        const val = form.querySelector('input[name="from_time"]').value;
        if(!val) return;
        const [h,m] = val.split(':').map(Number);
        const dt = new Date();
        dt.setHours(h, m + 15);
        const pad = n=>n.toString().padStart(2,'0');
        form.querySelector('input[name="to_time"]').value = `${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    };
    setCurrentTime();
    form.querySelector('input[name="from_time"]').addEventListener('change', adjustEndTime);

    form.addEventListener('submit', e=>{
        e.preventDefault();
        const data = new FormData(form);
        fetch('/add', {method:'POST', body:data}).then(()=>location.reload());
    });

    const editForm = document.getElementById('edit-form');
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));

    document.querySelectorAll('.edit-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            const idx = btn.dataset.index;
            fetch(`/edit/${idx}`, {headers:{'X-Requested-With':'XMLHttpRequest'}})
                .then(r=>r.json())
                .then(row=>{
                    editForm.dataset.index = idx;
                    editForm.date.value = row.Date;
                    editForm.from_time.value = row['From Time'];
                    editForm.to_time.value = row['To Time'];
                    editForm.task.value = row.Task;
                    editForm.description.value = row.Description;
                    editForm.completed.checked = row.Completed === '1';
                    editModal.show();
                });
        });
    });

    editForm.addEventListener('submit', e=>{
        e.preventDefault();
        const idx = editForm.dataset.index;
        const fd = new FormData(editForm);
        fetch(`/edit/${idx}`, {method:'POST', body:fd, headers:{'X-Requested-With':'XMLHttpRequest'}})
            .then(()=>location.reload());
    });

    document.querySelectorAll('.day-chart').forEach(c=>{
        const ctx = c.getContext('2d');
        const data = JSON.parse(c.dataset.hours);
        const names = Object.keys(data);
        const hours = names.map(n=>data[n]);
        new Chart(ctx,{type:'bar',data:{labels:names,datasets:[{label:'Hours',data:hours,backgroundColor:'rgba(123,104,238,0.6)'}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    });
});
</script>
</body>
</html>
